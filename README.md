没有 SLAM，虚拟现实将永远停留在座椅上。

# 第2讲　初识SLAM

1. 我在什么地方？——定位。
2. 周围环境是什么样？——建图。

当谈论视觉 SLAM 时，我们主要是指如何用相机解决定位和建图问题。

## 单目相机

近处的物体移动快，远处的物体则运动缓慢。于是，当相机移动时，这些物体在图像上的运动就形成了视差。通过视差，我们就能定量地判断哪些物体离得远，哪些物体离得近。

如果把相机的运动和场景大小同时放大两倍，单目相机所看到的像是一样的。同样地，把这个大小乘以任意倍数，我们都将看到一样的景象。这说明，单目SLAM估计的轨迹和地图将与真实的轨迹和地图相差一个因子，也就是所谓的尺度（Scale）。由于单目SLAM无法仅凭图像确定这个真实尺度，所以又称为尺度不确定性。

平移之后才能计算深度，以及无法确定真实尺度，这两件事情给单目SLAM的应用造成了很大的麻烦。其根本原因是通过单张图像无法确定深度。所以，为了得到这个深度，人们开始使用双目和深度相机。

## 双目相机和深度相机

### 双目相机

双目相机由两个单目相机组成，但这两个相机之间的距离〔称为基线（Baseline）〕是已知的。我们通过这个基线来估计每个像素的空间位置——这和人眼非常相似。我们人类可以通过左右眼图像的差异判断物体的远近，在计算机上也是同样的道理。

双目相机测量到的深度范围与基线相关。基线距离越大，能够测量到的就越远。

双目或多目相机的缺点是配置与标定均较为复杂，其深度量程和精度受双目的基线与分辨率限制，而且视差的计算非常消耗计算资源，需要使用 GPU 和 FPGA 设备加速后，才能实时输出整张图像的距离信息。因此在现有的条件下，计算量是双目的主要问题之一。

### 深度相机

深度相机（RGB-D 相机）通过主动向物体发射光并接收返回的光，测出物体离相机的距离。这部分并不像双目那样通过软件计算来解决，而是通过物理的测量手段，所以相比于双目可节省大量的计算量。

不过，现在多数 RGB-D 相机还存在测量范围窄、噪声大、视野小、易受日光干扰、无法测量透射材质等诸多问题，在 SLAM 方面，主要用于室内 SLAM，室外则较难应用。

## 经典视觉 SLAM 框架

1. 传感器信息读取
2. 视觉里程计(Visual Odometry, VO)
	- 视觉里程计关心相邻图像之间的相机运动，最简单的情况当然是两张图像之间的运动关系。
	- 仅通过视觉里程计来估计轨迹，将不可避免地出现累计漂移(Accumulating Drift)。
	- 还需要两种技术:后端优化x和回环检测。回环检测负责把“机器人回到原始位置”的事情检测出来，而后端优化则根据该信息，校正整个轨迹的形状。
3. 后端优化(Optimization)
	- 在视觉 SLAM 中，前端和计算机视觉研究领域更为相关，比如图像的特征提取与匹配等，后端则主要是滤波与非线性优化算法。
4. 回环检测(Loop Closing)
	- 又称闭环检测(Loop Closure Detection)，主要解决位置估计随时间漂移的问题。
	- 我们可以判断图像间的相似性，来完成回环检测。如果回环检测成功，可以显著地减小累积误差。
5. 建图(Mapping)
	- 度量地图(Metric Map)
		- 度量地图强调精确地表示地图中物体的位置关系。
	- 拓扑地图(Topological Map)
		- 拓扑地图更强调地图元素之间的关系。拓扑地图是一个图(Graph)，由节点和边组成，只考虑节点间的连通性，例如 A，B 点是连通的，而不考虑如何从 A 点到达 B 点的过程。

如果把工作环境限定在静态、刚体，光照变化不明显、没有人为干扰的场景，那么，这个 SLAM 系统是相当成熟的了。

## SLAM 问题的数学表述

- 运动方程：x_k = f (x_{k−1},u_k,w_k)
- 观测方程：z_{k,j} = h (y_j,x_k,v_{k,j})

> 我们按照运动和观测方程是否为线性，噪声是否服从高斯分布进行分类，分为线性/非线性和高斯/非高斯系统。其中线性高斯系统(Linear Gaussian, LG 系统)是最简单的，它的无偏的最优估计可以由卡尔曼滤波器(Kalman Filter, KF)给出。而在复杂的非线性非高斯系统(Non-Linear Non-Gaussian，NLNG 系统)中，我们会使用以扩展卡尔曼滤波器(Extended Kalman Filter, EKF)和非线性优化两大类方法去求解它。

---

# 第二讲 三维刚体运动

视觉 SLAM 的基本问题之一:一个刚体在三维空间中的运动是如何描述的。

## 旋转矩阵

相机运动是一个刚体运动，它保证了同一个向量在各个坐标系下的长度和夹角都不会发生变化。这种变换称为欧氏变换。这样一个欧氏变换由一个旋转和一个平移两部分组成。

旋转矩阵有一些特别的性质。事实上，它是一个行列式为 1 的正交矩阵x。反之，行列式为 1 的正交矩阵也是一个旋转矩阵。所以，我们可以把旋转矩阵的集合定义如下:

> SO(n)={R∈R^n×n|RR^T =I,det(R)=1}.

SO(n) 是特殊正交群(Special Orthogonal Group)的意思。

反向变换为：R^-1 = R^T

引入齐次坐标：使变换关系为线性。变换矩阵为旋转矩阵和平移矩阵的和。

> 这是一个数学技巧：我们把一个三维向量的末尾添加 1，变成了四维向量，称为齐次坐标。对于这个四维向量，我们可以把旋转和平移写在一个矩阵里面，使得整个关系变成了线性关系。

变换矩阵 T 构成特殊欧氏群(Special Euclidean Group)：

![](./img/SE3.png)

其反向变换为：

![](./img/SE3_2.png)

```
（矩阵库）Eigen 实例：brew install eigen（in MacOS）
```

## 旋转向量、欧拉角和四元数

### 旋转向量

矩阵表示方式至少有以下几个缺点:

1. SO(3) 的旋转矩阵有九个量，但一次旋转只有三个自由度。因此这种表达方式是冗余的。同理，变换矩阵用十六个量表达了六自由度的变换。
2. 旋转矩阵自身带有约束：它必须是个正交矩阵，且行列式为 1。变换矩阵也是如此。当我们想要估计或优化一个旋转矩阵/变换矩阵时，这些约束会使得求解变得更困难。

使用三维向量表达旋转，六维向量表达变换：旋转向量（旋转轴+旋转角）+平移向量

由旋转向量到旋转矩阵的过程由罗德里格斯公式(Rodrigues’s Formula )表明。

### 欧拉角

1. 绕物体的 Z 轴旋转，得到偏航角 yaw;
2. 绕旋转之后的 Y 轴旋转，得到俯仰角 pitch;
3. 绕旋转之后的 X 轴旋转，得到滚转角 roll。

欧拉角的一个重大缺点是会碰到著名的万向锁问题(Gimbal Lockx):在俯仰角为 ±90◦ 时，第一次旋转与第三次旋转将使用同一个轴，使得系统丢失了一个自由度(由三次旋转变成了两次旋转)。这被称为奇异性问题，在其他形式的欧拉角中也同样存在。理论上可以证明，只要我们想用三个实数来表达三维旋转时，都会不可避免地碰到奇异性问题。由于这种原理，欧拉角不适于插值和迭代，往往只用于人机交互中。

### 四元数

旋转矩阵用九个量描述三自由度的旋转，具有冗余性;欧拉角和旋转向量是紧凑的，但具有奇异性。事实上，我们找不到不带奇异性的三维向量描述方式。

- 单位四元数能够表达三维空间的旋转。
- 任意的旋转都可以由两个互为相反数的四元数表示。

用四元数表示旋转：(p 点绕轴 n 旋转θ)

1. p = \[0,x,y,z\] = \[0,v\].
2. q = \[cos θ/2,nsin θ/2\].
3. p′= qpq^−1.

- 四元数和旋转矩阵的转换：

![](./img/四元数和旋转矩阵的转换.png)

## 相似、仿射和射影变换

欧氏 变换保持了向量的长度和夹角，相当于我们把一个刚体原封不动地进行了移动或旋转，不改变它自身的样子。而其他几种变换则会改变它的外形：

1. 相似变换
	- 相似变换比欧氏变换多了一个自由度，它允许物体进行均匀的缩放。
2. 仿射变换
	- 仿射变换只要求旋转矩阵是一个可逆矩阵，而不必是正交矩阵。仿射变换也叫正交投影。经过仿射变换之后，立方体就不再是方的了，但是各个面仍然是平行四边形。
3. 射影变换
	- 左上角为可逆矩阵 A，右上为平移 t，左下缩放 aT 。由于采用齐坐标，当 v ̸= 0 时，我们可以对整个矩阵除以 v 得到一个右下角为 1 的矩阵;否则，则得到右下角为 0 的矩阵。因此，2D 的射影变换一共有 8 个自由度，3D 则共有 15 个自由度。射影变换是现在讲过的变换中，形式最为一般的。从真实世界到相机照片的变换可以看成一个射影变换。读者可以想象一个原本方形的地板砖，在照片当中是什么样子:首先，它不再是方形的。由于近大远小的关系，它甚至不是平行四边形，而是一个不规则的四边形。

- 常见变换性质比较

![](./img/常见变换性质比较.png)

**从真实世界到相机照片的变换是一个射影变换。如果相机的焦距为
无穷远，那么这个变换则为仿射变换**。

**T_{wc} 的位移向量就是相机的世界坐标：p_w = T_{wc}0 = t_wc**.

```
Eigen 实例：变换
Pangolin 实例：可视化（Pangolin是对OpenGL进行封装的轻量级的OpenGL输入/输出和视频显示的库。）
```

---

# 李群与李代数

在 SLAM 中位姿是未知的，而我们需要解决什么样的相机位姿最符合当前观测数据这样的问题。一种典型的方式是把它构建成一个优化问题，求解最优的 R, t，使得误差最小化。

## 李群与李代数基础

旋转矩阵自身是带有约束的(正交且行列式为 1)。它们作为优化变量时，会引入额外的约束，使优化变得困难。通过李群——李代数间的转换关系，我们希望把位姿估计变成无约束的优化问题，简化求解方式。

旋转或变换的集合都只对乘法封闭。对于这种只有一个运算的集合，我们把它叫做群。一个是特殊正交群 SO(3)，也就是旋转矩阵群，还有特殊欧氏群 SE(3)，也就是变换矩阵群，

李群是指具有连续(光滑)性质的群。SO(3) 和 SE(3) 都是李群。

**李代数的引出，略**

- [SLAM 为什么需要李群与李代数](https://mp.weixin.qq.com/s/sVjy9kr-8qc9W9VN78JoDQ)

R(t) = exp(φ0∧ · t)，这个式子只在t 附近有效。

当某个时刻的 R 已知时，存在一个向量 φ ，二者满足这个矩阵指数关系。而这个 φ ，就是对应到 SO(3) 上的李代数 so(3)。

每个李群都有与之对应的李代数。李代数描述了李群的局部性质。

## 指数与对数映射

### 指数映射

- R'(t) = φ0∧ · R(t)
- R(t) = exp(φ0∧ · t)

李代数小 so(3) 是三维向量 φ 的集合，每个向量 φi 的反对称矩阵都可以表达李群(大 SO(3))上旋转矩阵 R 的导数，而 R 和 φ 是一个指数映射关系。也就是说，李群空间的任意一个旋转矩阵 R 都可以用李代数空间的一个向量的反对称矩阵指数来近似。

小 so(3) 的李代数空间就是由旋转向量组成的的空间，其物体意义就是旋转向量。而其指数映射关系就是罗德里格斯公式，

### 对数映射

反过来，用对数映射也能把大 SO(3) 李群空间中元素映射到小 so(3) 李代数空间中去。

- SO(3), SE(3), so(3), se(3) 的对应关系：

![](./img/李群与李代数的对应关系.png)

## 李代数求导与扰动模型

我们经常会构建与位姿有关的函数，然后讨论该函数关于位姿的导数，以调整当前的估计值。然而，SO(3), SE(3)上并没有良好定义的加法，它们只是群。如果我们把T 当成一个普通矩阵来处理优化，那就必须对它加以约束。而从李代数角度来说，由于李代数由向量组成，具有良好的加法运算。因此，使用李代数解决求导问题的思路分为两种：

1. 用李代数表示姿态，然后根据李代数加法来对李代数求导。
2. 对李群左乘或右乘微小扰动，然后对该扰动求导，称为左扰动和右扰动模型。

第一种方式对应到李代数的求导模型，而第二种则对应到扰动模型。确实实际SLAM问题中，扰动模型比较实用方便。

## 相似变换群与李代数

我们已经介绍过单目的尺度不确定性。如果在单目 SLAM 中使用 SE(3) 表示位姿，那么由于尺度不确定性与尺度漂移，整个 SLAM 过程中的尺度会发生变化，这在 SE(3) 中未能体现出来。因此，在单目情况下我们一般会显式地把尺度因子表达出来。用数学语言来说，对于位于空间的点 p，在相机坐标系下要经过一个相似变换，而非欧氏变换。

> (李代数库)Sophus：使用非模板类的老版本

---

















